name: android_build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout the code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Set up Android SDK for Android 13 (API 33)
        uses: android-actions/setup-android@v2
        with:
          api-level: 33          # Android 13
          build-tools-version: '33.0.0'
          platforms: 'android-33'
          ndk-version: '25.2.9519653'
      
      - id: get-project
        name: Get project name
        run: echo "PROJECT=$(cat project-to-build)" >> $GITHUB_OUTPUT
      
      - name: Clone project
        run: git clone --depth=1 ${{ steps.get-project.outputs.PROJECT }} project
      
      - name: Build the app for Android 13
        working-directory: ./project
        env:
          GRADLE_OPTS: '-Dorg.gradle.daemon=false'
        run: |
          # 设置执行权限
          chmod +x gradlew
          
          # 构建 APK (针对 Android 13)
          ./gradlew clean
          ./gradlew assembleDebug --stacktrace
          
          # 验证 APK
          find . -name "*.apk" -type f | head -5
      
      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-13-apk
          path: |
            ./project/**/*.apk
          retention-days: 7
      
      - name: Generate Android 13 build info
        if: always()
        run: |
          echo "Android 13 (API 33) Build" >> build-info.txt
          echo "Build completed at: $(date)" >> build-info.txt
          echo "Target API: 33 (Android 13)" >> build-info.txt
          echo "Build Tools: 33.0.0" >> build-info.txt
      
      - name: Upload build info
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: android13-build-info
          path: build-info.txt